cd /Users/luyi/GRS_workflow
DIR_PROJ=`pwd`

# the project directory has a pre-specified file/folder structure, see GRS_workflow.tree

# Important: LDSC does not work properly on the recent versions of pandas 
# e.g. failed on pandas=0.22
# need pandas=0.20.1 or lower


# list the path of pre-installed python-based tools
DIR_Python_convert=/Users/luyi/Softwares/python_convert
DIR_LDSC=/Users/luyi/Softwares/ldsc

# also download some dependent reference data to the data/ref/
mkdir data/ref/ldsc
cd data/ref/ldsc
wget https://data.broadinstitute.org/alkesgroup/LDSCORE/eur_w_ld_chr.tar.bz2 
tar xf eur_w_ld_chr.tar.bz2 
rm eur_w_ld_chr.tar.bz2 # delete once extracted the folder
cd -

###### STEP1: Processing external sumstats (either publicly available or through collaboration) 

# GRS should be labelled as "consortium_trait_year_population" 
# 	- year: yr of publication, or yr of analysis if not published yet
#	- population, also indicate sample exclusions: 
#		e.g. GLB(global)/EUR/EUR-SWE(excl. SWE samples)/EUR-NORDIC(excl. Nordic samples) 

# lists of sumstats files - and corresponding GRS name - NCASE - NCONT
# 	ckqny.scz2snpres.gz - PGC_SCZ_2014_GLB - 34241 - 45604
# 	PGC_MDD2018_10kSNPs.gz - PGC_MDD_2018_GLB - 135458 - 344901 


# Note: always incl. the sample size N/Ncase/Ncon
sumstat="ckqny.scz2snpres.gz"
name="PGC_SCZ_2014_GLB"
Ncase="34241" 
Ncont="45604"

sumstat="PGC_MDD2018_10kSNPs.gz"
name="PGC_MDD_2018_GLB"
Ncase="135458" 
Ncont="344901"

# need to run this step for each trait - with different parameters
bash code/step1_preparesumstats.sh \
${DIR_PROJ} ${DIR_Python_convert} ${DIR_LDSC} ${sumstat} ${name} ${Ncase} ${Ncont} \
> logs/step1_preparesumstats_${name}.log



###### STEP2: taking genetic data as local input 
# soft link user-provide input data to the project directory
ln -s /Users/luyi/GRS_workflow_Testdata/s1 data/geno/raw/
ln -s /Users/luyi/GRS_workflow_Testdata/s2 data/geno/raw/


MAF=0.01
INFO=0.6

STUDY_LIST="s1 s2"

for STUDY in ${STUDY_LIST}; do
bash code/step2_preparingtarget_Ricopili.sh \
${DIR_PROJ} ${STUDY} ${MAF} ${INFO} \
> logs/step2_preparingtarget_Ricopili_${STUDY}.log
done 


###### STEP3: calculating the genetic risk score
# need to run the script for 2 sumstats x 2 studies
GRS_NAME_LIST="PGC_SCZ_2014_GLB PGC_MDD_2018_GLB"

for STUDY in ${STUDY_LIST}; do

	for GRS_NAME in ${GRS_NAME_LIST}; do
	bash code/step3_calculateGRS.sh \
	${DIR_PROJ} ${STUDY} ${GRS_NAME} \
	> logs/step3_calculateGRS_${STUDY}_${GRS_NAME}.log 2>&1
	done
	
done

